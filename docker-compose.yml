# ============================================
# DOCKER COMPOSE PARA E-COMMERCE
# ============================================

services:
  # ==========================================
  # SERVICIO DE BASE DE DATOS MYSQL
  # ==========================================
  mysql:
    container_name: ecommerce_mysql
    image: mysql:8.0
    restart: always

    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: ecommerce_db
      MYSQL_USER: ecommerce_user
      MYSQL_PASSWORD: ecommerce123

    ports:
      - "3306:3306"

    volumes:
      - mysql_data:/var/lib/mysql

    networks:
      - ecommerce_network

    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot123" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # SERVICIO DE LA APLICACIÓN SPRING BOOT
  # ==========================================
  app:
    container_name: ecommerce_app
    build:
      context: .
      dockerfile: Dockerfile
    restart: always

    ports:
      - "8080:8080"

    environment:
      SPRING_APPLICATION_NAME: ecommerce
      SPRING_PROFILES_ACTIVE: prod

      # Base de datos
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/ecommerce_db?useSSL=false&serverTimezone=America/Lima&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root123

      # JPA
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "false"
      SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: "false"

      # Inicialización
      SPRING_SQL_INIT_MODE: always
      SPRING_JPA_DEFER_DATASOURCE_INITIALIZATION: "true"

      # ✅ CRÍTICO: Directorio de uploads (se mapea al volumen)
      APP_UPLOAD_DIR: /app/uploads/productos/

      # Empresa
      EMPRESA_NOMBRE: Game Store SAC
      EMPRESA_RUC: 22345678901
      EMPRESA_DIRECCION: Las Ñustas 240, La Victoria, Lima
      EMPRESA_TELEFONO: 01-1234567
      EMPRESA_EMAIL: ventas@gamestore.com

      # API
      API_DECOLECTA_TOKEN: sk_9739.xfKEozZkKVg69oje8RACY8preIWY6nwh

    depends_on:
      mysql:
        condition: service_healthy

    volumes:
      # ✅ SOLUCIÓN: Mapear directorio local para que las imágenes persistan
      # Esto crea/usa la carpeta "uploads" en el mismo directorio del docker-compose.yml
      - ./uploads:/app/uploads

    networks:
      - ecommerce_network

# ==========================================
# VOLÚMENES PERSISTENTES
# ==========================================
volumes:
  mysql_data:
    driver: local
  # ❌ ELIMINADO: Ya no necesitamos uploads_data porque usamos mapeo directo
  # uploads_data:
  #   driver: local

  # ==========================================
  # RED DE COMUNICACIÓN
  # ==========================================
networks:
  ecommerce_network:
    driver: bridge
