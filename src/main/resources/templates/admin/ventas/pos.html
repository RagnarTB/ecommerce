<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: head('Punto de Venta - POS')}"></head>

<body class="hold-transition sidebar-mini layout-fixed layout-navbar-fixed">
    <div class="wrapper">

        <nav th:replace="~{fragments/navbar :: navbar}"></nav>

        <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>

        <div class="content-wrapper">
            <div class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1 class="m-0">
                                <i class="fas fa-cash-register text-danger"></i>
                                Punto de Venta (POS)
                            </h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">Dashboard</a></li>
                                <li class="breadcrumb-item active">POS</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <section class="content">
                <div class="container-fluid">

                    <div id="alertContainer"></div>

                    <div class="row">
                        <div class="col-lg-7">
                            <div class="card card-danger card-outline gamer-card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-search"></i> Buscar Productos
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-3">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-danger">
                                                <i class="fas fa-search"></i>
                                            </span>
                                        </div>
                                        <input type="text" class="form-control form-control-lg gamer-input"
                                            id="searchProduct"
                                            placeholder="Buscar por nombre, SKU o escanear código de barras..."
                                            autocomplete="off">
                                    </div>

                                    <div id="productGrid" class="row" style="max-height: 500px; overflow-y: auto;">
                                        <div class="col-12 text-center text-muted py-5" id="noProducts">
                                            <i class="fas fa-box-open fa-3x mb-3"></i>
                                            <p>Comienza a buscar productos...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-5">
                            <div class="card card-danger card-outline gamer-card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-user"></i> Cliente
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control gamer-input" id="clienteDocumento"
                                            placeholder="DNI o RUC del cliente" maxlength="11">
                                        <div class="input-group-append">
                                            <button class="btn btn-danger" type="button" id="btnBuscarCliente">
                                                <i class="fas fa-search"></i> Buscar
                                            </button>
                                        </div>
                                    </div>

                                    <div id="clienteInfo" class="alert alert-info" style="display: none;">
                                        <strong id="clienteNombre"></strong><br>
                                        <small id="clienteDocumentoCompleto"></small>
                                        <input type="hidden" id="clienteId">
                                    </div>
                                </div>
                            </div>

                            <div class="card card-danger card-outline gamer-card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-shopping-cart"></i> Carrito de Compras
                                    </h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-sm btn-danger" id="btnLimpiarCarrito">
                                            <i class="fas fa-trash"></i> Limpiar
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div id="cartItems" style="max-height: 300px; overflow-y: auto;">
                                        <div class="text-center text-muted py-5" id="emptyCart">
                                            <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                                            <p>Carrito vacío</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Subtotal:</strong></td>
                                            <td class="text-right">
                                                <strong>S/ <span id="subtotal">0.00</span></strong>
                                            </td>
                                        </tr>
                                        <!-- === INICIO INTEGRACIÓN === -->
                                        <tr>
                                            <td>Descuento:</td>
                                            <td class="text-right">
                                                <!-- Asegúrate que el ID sea 'descuento' -->
                                                <input type="number" class="form-control form-control-sm text-right"
                                                    id="descuento" value="0.00" min="0" step="0.01"
                                                    style="max-width: 100px; display: inline-block;">
                                                <!-- display inline -->
                                                <span style="margin-left: 5px;">S/</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Envío:</td>
                                            <td class="text-right">
                                                <!-- Asegúrate que el ID sea 'costoEnvio' -->
                                                <input type="number" class="form-control form-control-sm text-right"
                                                    id="costoEnvio" value="0.00" min="0" step="0.01"
                                                    style="max-width: 100px; display: inline-block;">
                                                <span style="margin-left: 5px;">S/</span>
                                            </td>
                                        </tr>
                                        <!-- === FIN INTEGRACIÓN === -->
                                        <tr>
                                            <td>IGV (18%):</td>
                                            <td class="text-right">
                                                <strong>S/ <span id="igv">0.00</span></strong>
                                            </td>
                                        </tr>
                                        <tr class="bg-light">
                                            <td>
                                                <h4><strong>TOTAL:</strong></h4>
                                            </td>
                                            <td class="text-right">
                                                <h4 class="text-danger">
                                                    <strong>S/ <span id="total">0.00</span></strong>
                                                </h4>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <div class="card card-danger card-outline gamer-card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-money-bill-wave"></i> Forma de Pago
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Tipo de Pago</label>
                                        <select class="form-control gamer-input" id="tipoPago">
                                            <option value="CONTADO">Contado</option>
                                            <option value="CREDITO">Crédito</option>
                                        </select>
                                    </div>

                                    <div class="form-group" id="numCuotasGroup" style="display: none;">
                                        <label>Número de Cuotas</label>
                                        <input type="number" class="form-control gamer-input" id="numCuotas" min="1"
                                            max="24" value="12">
                                    </div>

                                    <div id="metodoPagoGroup">
                                        <label>Método de Pago</label>
                                        <div class="row">
                                            <div class="col-6 mb-2">
                                                <div class="custom-control custom-radio">
                                                    <input class="custom-control-input" type="radio" id="pagoEfectivo"
                                                        name="metodoPago" value="EFECTIVO" checked>
                                                    <label for="pagoEfectivo" class="custom-control-label">
                                                        <i class="fas fa-money-bill-wave text-success"></i> Efectivo
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-6 mb-2">
                                                <div class="custom-control custom-radio">
                                                    <input class="custom-control-input" type="radio" id="pagoTarjeta"
                                                        name="metodoPago" value="TARJETA">
                                                    <label for="pagoTarjeta" class="custom-control-label">
                                                        <i class="fas fa-credit-card text-primary"></i> Tarjeta
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-6 mb-2">
                                                <div class="custom-control custom-radio">
                                                    <input class="custom-control-input" type="radio" id="pagoYape"
                                                        name="metodoPago" value="YAPE">
                                                    <label for="pagoYape" class="custom-control-label">
                                                        <i class="fas fa-mobile-alt text-info"></i> Yape/Plin
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-6 mb-2">
                                                <div class="custom-control custom-radio">
                                                    <input class="custom-control-input" type="radio"
                                                        id="pagoTransferencia" name="metodoPago" value="TRANSFERENCIA">
                                                    <label for="pagoTransferencia" class="custom-control-label">
                                                        <i class="fas fa-exchange-alt text-warning"></i> Transferencia
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group mt-3" id="montoRecibidoGroup">
                                        <label>Monto Recibido</label>
                                        <input type="number" class="form-control form-control-lg gamer-input"
                                            id="montoRecibido" placeholder="0.00" step="0.01">
                                    </div>

                                    <div id="vueltoGroup" style="display: none;">
                                        <div class="alert alert-success text-center">
                                            <h4>Vuelto: S/ <span id="vuelto">0.00</span></h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <button type="button" class="btn btn-success btn-lg btn-block gamer-btn"
                                        id="btnProcesarVenta">
                                        <i class="fas fa-check-circle"></i> PROCESAR VENTA
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </section>
        </div>

        <footer th:replace="~{fragments/footer :: footer}"></footer>
        <th:block th:replace="~{fragments/scripts :: scripts}"></th:block>

        <script th:inline="javascript">
            (function () {
                // ============================================
                // VARIABLES GLOBALES
                // ============================================
                let productos = /*[[${productos}]]*/[];
                let carrito = [];
                let clienteSeleccionado = null;

                // ============================================
                // INICIALIZACIÓN
                // ============================================
                $(document).ready(function () {
                    console.log("🚀 POS Inicializado");
                    console.log("📦 Productos cargados:", productos); // Verificar que productos tenga datos
                    cargarProductos();
                    configurarEventos();
                });

                // ============================================
                // CARGAR PRODUCTOS
                // ============================================
                function cargarProductos() {
                    if (productos && productos.length > 0) { // Verificar si productos existe y no está vacío
                        mostrarProductos(productos);
                    } else {
                        console.warn("⚠️ No hay productos para mostrar o la variable 'productos' es inválida.");
                        $('#productGrid').html(`
                            <div class="col-12 text-center text-muted py-5">
                                <i class="fas fa-box-open fa-3x mb-3"></i>
                                <p>No hay productos disponibles para mostrar.</p>
                            </div>
                          `);
                    }
                }

                // ============================================
                // CONFIGURAR EVENTOS
                // ============================================
                function configurarEventos() {
                    console.log("🎯 Eventos POS configurados correctamente");

                    // Búsqueda de productos
                    $('#searchProduct').on('keyup', function () {
                        const query = $(this).val().toLowerCase();
                        if (!productos) return; // Salir si no hay productos
                        if (query.length >= 2) {
                            const filtrados = productos.filter(p =>
                                p.nombre.toLowerCase().includes(query) ||
                                (p.codigoSku && p.codigoSku.toLowerCase().includes(query))
                            );
                            mostrarProductos(filtrados);
                        } else if (query.length === 0) {
                            mostrarProductos(productos);
                        }
                    });

                    // Búsqueda de cliente
                    $('#btnBuscarCliente').on('click', buscarCliente);
                    $('#clienteDocumento').on('keypress', function (e) {
                        if (e.which === 13) buscarCliente();
                    });

                    // Limpiar carrito
                    $('#btnLimpiarCarrito').on('click', function () {
                        Swal.fire({
                            title: '¿Limpiar Carrito?',
                            text: "Se eliminarán todos los productos del carrito.",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#3085d6',
                            confirmButtonText: 'Sí, limpiar',
                            cancelButtonText: 'Cancelar'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                carrito = [];
                                clienteSeleccionado = null;
                                $('#clienteInfo').hide();
                                $('#clienteDocumento').val('');
                                $('#descuento').val('0.00'); // Resetear descuento
                                $('#costoEnvio').val('0.00'); // Resetear envío
                                actualizarCarrito();
                                showAlert('Carrito limpiado', 'info');
                            }
                        });
                    });


                    // Cambio de tipo de pago
                    $('#tipoPago').on('change', function () {
                        if ($(this).val() === 'CREDITO') {
                            $('#numCuotasGroup').slideDown();
                            $('#metodoPagoGroup').slideUp();
                            $('#montoRecibidoGroup').slideUp();
                            $('#vueltoGroup').slideUp();
                        } else {
                            $('#numCuotasGroup').slideUp();
                            $('#metodoPagoGroup').slideDown();
                            // Mostrar monto recibido solo si es efectivo
                            if ($('input[name="metodoPago"]:checked').val() === 'EFECTIVO') {
                                $('#montoRecibidoGroup').slideDown();
                            } else {
                                $('#montoRecibidoGroup').slideUp();
                                $('#vueltoGroup').slideUp(); // Ocultar vuelto si no es efectivo
                            }
                        }
                    });

                    // Cambio de método de pago
                    $('input[name="metodoPago"]').on('change', function () {
                        if ($(this).val() === 'EFECTIVO') {
                            $('#montoRecibidoGroup').slideDown();
                        } else {
                            $('#montoRecibidoGroup').slideUp();
                            $('#montoRecibido').val(''); // Limpiar monto recibido
                            $('#vueltoGroup').slideUp(); // Ocultar vuelto
                        }
                    });


                    // Cálculo de vuelto
                    $('#montoRecibido').on('keyup change', calcularVuelto);

                    // Cambios en descuento y envío
                    $('#descuento, #costoEnvio').on('keyup change input', calcularTotales); // Added 'input' for better reactivity


                    // Procesar venta
                    $('#btnProcesarVenta').off('click').on('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log("🟢 Click detectado en Procesar Venta");
                        procesarVenta();
                    });
                }

                // ============================================
                // MOSTRAR PRODUCTOS
                // ============================================
                function mostrarProductos(lista) {
                    const grid = $('#productGrid');
                    grid.empty();

                    if (!lista || lista.length === 0) {
                        grid.html(`
                            <div class="col-12 text-center text-muted py-5" id="noProductsFound">
                                <i class="fas fa-search fa-3x mb-3"></i>
                                <p>No se encontraron productos con ese criterio.</p>
                            </div>
                          `);
                        $('#noProducts').hide(); // Ocultar el mensaje inicial
                        return;
                    }
                    $('#noProducts').hide(); // Ocultar el mensaje inicial

                    lista.forEach(producto => {
                        const imagenUrl = (producto.imagenPrincipal && producto.imagenPrincipal.url)
                            ? `/uploads/productos/${producto.imagenPrincipal.url}`
                            : '/img/placeholder-game.jpg';
                        const stock = producto.stockActual || 0;
                        const sinStock = stock <= 0;

                        grid.append(`
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card gamer-card product-card ${sinStock ? 'sin-stock' : ''}"
                                    ${sinStock ? '' : `onclick="agregarAlCarrito(${producto.id})"`}>
                                    <img src="${imagenUrl}"
                                        class="card-img-top"
                                        alt="${producto.nombre}"
                                        style="height: 150px; object-fit: cover;"
                                        onerror="this.onerror=null; this.src='/img/placeholder-game.jpg';"> <!-- Fallback image -->
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1" style="font-size: 0.9rem; min-height: 40px;">
                                            ${producto.nombre}
                                        </h6>
                                        <p class="mb-1">
                                            <span class="badge badge-${sinStock ? 'danger' : 'success'}">
                                                Stock: ${stock}
                                            </span>
                                        </p>
                                        <p class="text-danger mb-0">
                                            <strong>S/ ${producto.precioActual ? producto.precioActual.toFixed(2) : 'N/A'}</strong>
                                        </p>
                                    </div>
                                </div>
                            </div>
                          `);
                    });
                }


                // ============================================
                // AGREGAR AL CARRITO
                // ============================================
                window.agregarAlCarrito = function (productoId) {
                    if (!productos) return; // Seguridad extra
                    const producto = productos.find(p => p.id === productoId);
                    if (!producto) return;

                    if (producto.stockActual == null || producto.stockActual <= 0) {
                        showAlert('No hay stock disponible para ' + producto.nombre, 'warning');
                        return;
                    }

                    const itemExistente = carrito.find(item => item.id === productoId);
                    if (itemExistente) {
                        if (itemExistente.cantidad >= producto.stockActual) {
                            showAlert('No hay más stock disponible para ' + producto.nombre, 'warning');
                            return;
                        }
                        itemExistente.cantidad++;
                    } else {
                        // Validar que el precio sea un número válido
                        const precioValido = typeof producto.precioActual === 'number' && !isNaN(producto.precioActual);
                        if (!precioValido) {
                            console.error("Precio inválido para producto:", producto);
                            showAlert('El producto seleccionado tiene un precio inválido.', 'error');
                            return;
                        }
                        carrito.push({
                            id: producto.id,
                            nombre: producto.nombre,
                            precio: producto.precioActual,
                            cantidad: 1,
                            stockMax: producto.stockActual
                        });
                    }
                    actualizarCarrito();
                    showAlert(`${producto.nombre} agregado al carrito`, 'success');
                };


                // ============================================
                // ACTUALIZAR CARRITO
                // ============================================
                function actualizarCarrito() {
                    const container = $('#cartItems');
                    container.empty();

                    if (carrito.length === 0) {
                        container.html(`
                            <div class="text-center text-muted py-5" id="emptyCart">
                                <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                                <p>Carrito vacío</p>
                            </div>
                          `);
                        calcularTotales();
                        return;
                    }

                    carrito.forEach((item, index) => {
                        const subtotalItem = (item.precio * item.cantidad).toFixed(2);
                        container.append(`
                            <div class="cart-item p-3 border-bottom">
                                <div class="row align-items-center">
                                    <div class="col-5">
                                        <small><strong>${item.nombre}</strong></small><br>
                                        <small class="text-muted">S/ ${item.precio ? item.precio.toFixed(2) : 'N/A'}</small>
                                    </div>
                                    <div class="col-5">
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-prepend">
                                                <button class="btn btn-outline-secondary"
                                                        type="button"
                                                        onclick="cambiarCantidad(${index}, -1)">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                            </div>
                                            <input type="text"
                                                class="form-control text-center"
                                                value="${item.cantidad}"
                                                readonly>
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary"
                                                        type="button"
                                                        onclick="cambiarCantidad(${index}, 1)">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-2 text-right">
                                        <button class="btn btn-sm btn-danger"
                                                onclick="eliminarDelCarrito(${index})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="row mt-1">
                                    <div class="col-12 text-right">
                                        <small>Subtotal: S/ ${subtotalItem}</small>
                                    </div>
                                </div>
                            </div>
                          `);
                    });

                    calcularTotales();
                }


                window.cambiarCantidad = function (index, cambio) {
                    const item = carrito[index];
                    if (!item) return; // Seguridad
                    const nuevaCantidad = item.cantidad + cambio;
                    if (nuevaCantidad <= 0) {
                        eliminarDelCarrito(index);
                        return;
                    }
                    if (nuevaCantidad > item.stockMax) {
                        showAlert('No hay más stock disponible para ' + item.nombre, 'warning');
                        return;
                    }
                    item.cantidad = nuevaCantidad;
                    actualizarCarrito();
                };

                window.eliminarDelCarrito = function (index) {
                    if (index >= 0 && index < carrito.length) {
                        const nombreEliminado = carrito[index].nombre;
                        carrito.splice(index, 1);
                        actualizarCarrito();
                        showAlert(`${nombreEliminado} eliminado del carrito`, 'info');
                    }
                };

                function calcularTotales() {
                    // Subtotal de productos
                    const subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
                    const descuento = parseFloat($('#descuento').val()) || 0;
                    const costoEnvio = parseFloat($('#costoEnvio').val()) || 0;

                    // Base imponible (subtotal - descuento + envío)
                    let baseImponible = subtotal - descuento + costoEnvio;
                    baseImponible = Math.max(0, baseImponible); // Asegurar que no sea negativo

                    // IGV (18% de la base imponible)
                    const igv = baseImponible * 0.18;

                    // Total con IGV incluido
                    const total = baseImponible + igv;

                    // Actualizar valores en la vista
                    $('#subtotal').text(subtotal.toFixed(2));
                    $('#igv').text(igv.toFixed(2));
                    $('#total').text(total.toFixed(2));

                    calcularVuelto(); // Recalcular vuelto cada vez que cambie el total
                }

                function calcularVuelto() {
                    if ($('#tipoPago').val() === 'CREDITO' || $('input[name="metodoPago"]:checked').val() !== 'EFECTIVO') {
                        $('#vueltoGroup').hide();
                        return;
                    }

                    const total = parseFloat($('#total').text()) || 0;
                    const recibido = parseFloat($('#montoRecibido').val()) || 0;
                    if (recibido > 0 && recibido >= total) {
                        const vuelto = recibido - total;
                        $('#vuelto').text(vuelto.toFixed(2));
                        $('#vueltoGroup').show();
                    } else {
                        $('#vueltoGroup').hide();
                    }
                }

                // ============================================
                // BUSCAR CLIENTE - MEJORADO
                // ============================================
                function buscarCliente() {
                    const documento = $('#clienteDocumento').val().trim();
                    if (!documento) {
                        showAlert('Ingrese un documento (DNI o RUC)', 'warning');
                        return;
                    }

                    // Simple validación de longitud
                    if (documento.length !== 8 && documento.length !== 11) {
                        showAlert('El DNI debe tener 8 dígitos y el RUC 11 dígitos.', 'warning');
                        return;
                    }

                    Swal.fire({
                        title: 'Buscando cliente...',
                        text: 'Consultando base de datos y API externa si es necesario.',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    // Usar la ruta API que busca o crea
                    $.ajax({
                        url: '/api/clientes/obtener-o-crear', // Usar la ruta correcta
                        method: 'POST', // Es POST según tu API
                        contentType: 'application/json',
                        data: JSON.stringify({ numeroDocumento: documento }),
                        // Agrega token CSRF antes de enviar la petición
                        beforeSend: function (xhr) {
                            const token = $("meta[name='_csrf']").attr("content");
                            const header = $("meta[name='_csrf_header']").attr("content");
                            if (token && header) {
                                xhr.setRequestHeader(header, token);
                                console.log("🔒 CSRF Header set:", header);
                            } else {
                                console.warn("⚠️ CSRF meta tags no encontrados!");
                            }
                        },
                        success: function (response) {
                            Swal.close();
                            if (response.success && response.data) {
                                clienteSeleccionado = response.data; // Guardar el objeto cliente completo
                                $('#clienteId').val(response.data.id);
                                $('#clienteNombre').text(response.data.nombreCompleto || response.data.razonSocial); // Mostrar nombre o razón social
                                $('#clienteDocumentoCompleto').text(`${response.data.tipoDocumento}: ${response.data.numeroDocumento}`);
                                $('#clienteInfo').slideDown();
                                showAlert('Cliente encontrado/creado: ' + (response.data.nombreCompleto || response.data.razonSocial), 'success');
                            } else {
                                // Limpiar datos si no se encontró
                                clienteSeleccionado = null;
                                $('#clienteId').val('');
                                $('#clienteInfo').slideUp();
                                showAlert(response.error || 'Cliente no encontrado o DNI/RUC inválido.', 'error');
                            }
                        },
                        error: function (xhr) {
                            Swal.close();
                            clienteSeleccionado = null; // Limpiar en caso de error
                            $('#clienteId').val('');
                            $('#clienteInfo').slideUp();
                            let errorMsg = 'Error al buscar/crear cliente.';
                            try {
                                const errorResponse = JSON.parse(xhr.responseText);
                                errorMsg = errorResponse.error || errorMsg;
                            } catch (e) { /* Ignorar error de parseo */ }
                            showAlert(errorMsg, 'error');
                        }
                    });
                }


                // ============================================
                // PROCESAR VENTA
                // ============================================
                function procesarVenta() {
                    try {
                        console.log("📦 Iniciando procesarVenta()");

                        // Validaciones
                        if (carrito.length === 0) {
                            showAlert('El carrito está vacío', 'warning');
                            return;
                        }

                        const clienteDoc = $('#clienteDocumento').val().trim();
                        if (!clienteDoc) {
                            Swal.fire({ // Usar Swal para confirmación modal
                                title: 'Cliente no especificado',
                                text: 'No se ha especificado un cliente. ¿Desea continuar como "Cliente Varios"?',
                                icon: 'question',
                                showCancelButton: true,
                                confirmButtonText: 'Sí, continuar',
                                cancelButtonText: 'Cancelar'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    clienteSeleccionado = null; // Asegurar que sea null si no hay doc
                                    continuarProcesoVenta(); // Llamar a la función que continúa
                                }
                            });
                            return; // Detener aquí hasta que el usuario confirme
                        } else if (!clienteSeleccionado || clienteSeleccionado.numeroDocumento !== clienteDoc) {
                            // Si hay un documento pero no coincide con el cliente buscado (o no se buscó)
                            showAlert('El documento ingresado no coincide con el cliente buscado/confirmado. Por favor, busque de nuevo o borre el documento.', 'warning');
                            return;
                        }

                        // Si el clienteDoc existe y coincide, continuar directamente
                        continuarProcesoVenta();

                    } catch (error) {
                        console.error("❌ Error en validación inicial de procesarVenta():", error);
                        showAlert('Error al validar la venta: ' + error.message, 'error');
                    }
                }

                // Función separada para continuar después de la validación del cliente
                function continuarProcesoVenta() {
                    try {
                        const tipoPago = $('#tipoPago').val();
                        const metodoPago = $('input[name="metodoPago"]:checked').val();
                        const total = parseFloat($('#total').text()) || 0;

                        if (total <= 0) {
                            showAlert('El total de la venta debe ser mayor a cero.', 'warning');
                            return;
                        }

                        console.log("📊 Validando pago...", { tipoPago, metodoPago, total });

                        // Validar pago en efectivo
                        if (tipoPago === 'CONTADO' && metodoPago === 'EFECTIVO') {
                            const recibido = parseFloat($('#montoRecibido').val()) || 0;
                            if (recibido < total) {
                                showAlert('El monto recibido es insuficiente', 'warning');
                                return;
                            }
                        }

                        // Validar crédito
                        if (tipoPago === 'CREDITO') {
                            // ✅ VALIDACIÓN CRÍTICA: Exigir cliente real para crédito
                            if (!clienteSeleccionado || !clienteSeleccionado.id) {
                                showAlert('Para ventas a crédito debe registrar un cliente. Por favor, busque o registre el cliente primero.', 'error');
                                $('#clienteDocumento').focus();
                                return;
                            }

                            const numCuotas = parseInt($('#numCuotas').val());
                            if (isNaN(numCuotas) || numCuotas < 1 || numCuotas > 24) { // Validar NaN
                                showAlert('Ingrese un número de cuotas válido (1-24)', 'warning');
                                return;
                            }
                        }

                        console.log("✅ Validaciones pasadas, mostrando confirmación...");

                        // Confirmación final
                        Swal.fire({
                            title: '¿Procesar venta?',
                            html: `Cliente: <strong>${clienteSeleccionado ? (clienteSeleccionado.nombreCompleto || clienteSeleccionado.razonSocial) : 'Cliente Varios'}</strong><br>Total: <strong>S/ ${total.toFixed(2)}</strong>`,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonColor: '#28a745',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Sí, procesar',
                            cancelButtonText: 'Cancelar'
                        }).then(result => {
                            console.log("🔔 SweetAlert result:", result);
                            if (result.isConfirmed) {
                                console.log("✅ Usuario confirmó, enviando venta...");
                                try {
                                    enviarVenta();
                                } catch (error) {
                                    console.error("❌ Error al llamar enviarVenta():", error);
                                    showAlert('Error interno al preparar datos: ' + error.message, 'error');
                                }
                            } else {
                                console.log("❌ Usuario canceló");
                            }
                        }).catch(error => {
                            console.error("❌ Error en SweetAlert:", error);
                            showAlert('Error al mostrar confirmación.', 'error');
                        });
                    } catch (error) {
                        console.error("❌ Error en continuarProcesoVenta():", error);
                        showAlert('Error al procesar la venta: ' + error.message, 'error');
                    }
                }


                // ============================================
                // ENVIAR VENTA
                // ============================================
                function enviarVenta() {
                    try {
                        const tipoPago = $('#tipoPago').val();
                        const metodoPago = tipoPago === 'CONTADO' ? $('input[name="metodoPago"]:checked').val() : null;
                        const numCuotas = tipoPago === 'CREDITO' ? parseInt($('#numCuotas').val()) : null;
                        const total = parseFloat($('#total').text()) || 0;
                        const subtotal = parseFloat($('#subtotal').text()) || 0;
                        const descuento = parseFloat($('#descuento').val()) || 0;
                        const costoEnvio = parseFloat($('#costoEnvio').val()) || 0;
                        // const recibido = parseFloat($('#montoRecibido').val()) || 0; // No necesario enviar recibido

                        Swal.fire({
                            title: 'Procesando venta...',
                            text: 'Por favor, espere.',
                            allowOutsideClick: false,
                            didOpen: () => Swal.showLoading()
                        });

                        const data = {
                            // Enviar documento solo si no se seleccionó cliente específico (para Cliente Varios implícito)
                            clienteDocumento: !clienteSeleccionado ? $('#clienteDocumento').val().trim() : null,
                            tipoPago: tipoPago,
                            productos: carrito.map(item => ({
                                id: item.id,
                                cantidad: item.cantidad,
                                precio: item.precio // Asegurarse que el precio se envía correctamente
                            })),
                            // Enviar pagos solo si es CONTADO
                            pagos: tipoPago === 'CONTADO' ? [{
                                metodoPago: metodoPago,
                                // El backend debe usar el total calculado, no el monto pagado individual
                                monto: total // O podrías enviar el desglose si manejas multipago real
                            }] : [],
                            numCuotas: numCuotas,
                            subtotal: subtotal,
                            descuento: descuento,
                            costoEnvio: costoEnvio,
                            total: total
                        };

                        console.log("📤 Enviando JSON al backend:", JSON.stringify(data, null, 2));

                        // ------------------ AJAX con CSRF ------------------
                        $.ajax({
                            url: '/admin/ventas/pos/registrar',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(data),
                            dataType: 'json',

                            // ✅ Agrega token CSRF antes de enviar la petición
                            beforeSend: function (xhr) {
                                const token = $("meta[name='_csrf']").attr("content");
                                const header = $("meta[name='_csrf_header']").attr("content");
                                if (token && header) {
                                    xhr.setRequestHeader(header, token);
                                    console.log("🔒 CSRF Header set:", header);
                                } else {
                                    console.warn("⚠️ CSRF meta tags no encontrados!");
                                }
                            },
                            // -------------------------------------------------

                            success: function (response) {
                                Swal.close();
                                console.log("✅ Respuesta del backend:", response);

                                if (response.success) {
                                    let vueltoHtml = '';
                                    // Usar response.vuelto que ya viene redondeado del backend
                                    if (response.vuelto != null && response.vuelto > 0) {
                                        vueltoHtml = `<p><strong>Vuelto:</strong> S/ ${response.vuelto.toFixed(2)}</p>`;
                                    }

                                    Swal.fire({
                                        title: '¡Venta Registrada!',
                                        html: `
                                          <p>${response.mensaje || 'La venta se registró correctamente.'}</p>
                                          <p><strong>N° Venta:</strong> ${response.numeroVenta || 'N/A'}</p>
                                          <p><strong>Total:</strong> S/ ${response.total?.toFixed(2) || total.toFixed(2)}</p>
                                          ${vueltoHtml}
                                          <hr>
                                          <button id="swal-imprimir" class="btn btn-info gamer-btn">
                                              <i class="fas fa-print"></i> Imprimir Boleta
                                          </button>
                                        `,
                                        icon: 'success',
                                        showConfirmButton: true,
                                        confirmButtonText: 'OK',
                                        didOpen: () => {
                                            $('#swal-imprimir').on('click', function () {
                                                if (response.ventaId) {
                                                    window.open(`/admin/ventas/imprimir/${response.ventaId}`, '_blank');
                                                    Swal.clickConfirm();
                                                } else {
                                                    Swal.showValidationMessage('No se pudo obtener el ID para imprimir.');
                                                }
                                            });
                                        }
                                    }).then(() => {
                                        // Resetear todo después de cerrar el SweetAlert
                                        carrito = [];
                                        clienteSeleccionado = null;
                                        $('#clienteInfo').hide();
                                        $('#clienteDocumento').val('');
                                        $('#descuento').val('0.00'); // Usar '0.00'
                                        $('#costoEnvio').val('0.00'); // Usar '0.00'
                                        $('#montoRecibido').val('');
                                        $('#tipoPago').val('CONTADO').trigger('change');
                                        $('input[name="metodoPago"][value="EFECTIVO"]').prop('checked', true).trigger('change');
                                        actualizarCarrito(); // Esto llama a calcularTotales
                                        // No es necesario recargar productos aquí a menos que el stock cambie en tiempo real
                                        // cargarProductos();
                                    });
                                } else {
                                    Swal.fire('Error', response.error || 'No se pudo registrar la venta', 'error');
                                }
                            },

                            error: function (xhr, status, error) {
                                Swal.close();
                                console.error("❌ Error AJAX:", {
                                    status: status,
                                    error: error,
                                    statusText: xhr.statusText,
                                    responseJSON: xhr.responseJSON,
                                    responseText: xhr.responseText
                                });

                                let errorMsg = 'Error al procesar la venta. Verifique los datos e intente de nuevo.';

                                if (xhr.responseJSON && xhr.responseJSON.error) {
                                    errorMsg = xhr.responseJSON.error;
                                } else if (xhr.responseJSON && xhr.responseJSON.message) {
                                    errorMsg = xhr.responseJSON.message;
                                } else if (xhr.status === 404) {
                                    errorMsg = "Error: No se encontró la ruta (404). Verifica la URL.";
                                } else if (xhr.status === 403) {
                                    errorMsg = "Error: Acceso denegado (403). Verifica permisos o el token CSRF.";
                                }

                                Swal.fire('Error ' + xhr.status, errorMsg, 'error');
                            }
                        });
                        // --------------------------------------------------

                    } catch (error) {
                        Swal.close();
                        console.error("❌ Error en enviarVenta():", error);
                        showAlert('Error interno al enviar la venta: ' + error.message, 'error');
                    }
                }


                // Función de utilidad para mostrar alertas flotantes
                function showAlert(message, type = 'info', duration = 3000) {
                    const alertContainer = $('#alertContainer');
                    const alertId = 'alert-' + Date.now(); // ID único para cada alerta

                    const validTypes = ['success', 'info', 'warning', 'danger'];
                    const alertType = validTypes.includes(type) ? type : 'info';

                    const iconMap = { success: 'check-circle', info: 'info-circle', warning: 'exclamation-triangle', danger: 'times-circle' };
                    const icon = iconMap[alertType];

                    const alertHTML = `
                        <div id="${alertId}" class="alert alert-${alertType} alert-dismissible fade show m-3" role="alert" style="position: fixed; top: 60px; right: 10px; z-index: 1050; min-width: 250px;">
                            <i class="fas fa-${icon} mr-2"></i> ${message}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>`;

                    alertContainer.append(alertHTML);

                    setTimeout(() => {
                        $(`#${alertId}`).fadeOut(500, function () { $(this).remove(); });
                    }, duration);
                }

            })();
        </script>


        <style>
            .product-card {
                cursor: pointer;
                transition: all 0.2s ease-in-out;
                border: 2px solid transparent;
                height: 100%;
                /* Asegurar altura consistente */
                display: flex;
                /* Flex para alinear contenido */
                flex-direction: column;
                /* Alinear verticalmente */
            }

            .product-card .card-body {
                flex-grow: 1;
                /* Hacer que el body ocupe espacio disponible */
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                /* Empujar precio/stock abajo */
            }

            .product-card .card-title {
                min-height: 40px;
                /* Evitar saltos de altura por nombre largo */
            }

            .product-card:hover:not(.sin-stock) {
                /* Apply hover only if not sin-stock */
                transform: translateY(-5px) scale(1.02);
                box-shadow: 0 10px 25px rgba(220, 53, 69, 0.4);
                border-color: #dc3545;
            }

            .product-card.sin-stock {
                opacity: 0.6;
                cursor: not-allowed;
                background-color: #f8f9fa;
                /* Lighter background for inactive */
            }

            .product-card.sin-stock:hover {
                transform: none;
                box-shadow: none;
                border-color: transparent;
            }

            .product-card.sin-stock img {
                filter: grayscale(80%);
            }

            .cart-item {
                transition: background-color 0.3s ease;
            }

            .cart-item:hover {
                background-color: rgba(220, 53, 69, 0.05);
            }

            .cart-item small {
                font-size: 0.85rem;
            }

            #searchProduct:focus,
            #clienteDocumento:focus {
                border-color: #dc3545;
                box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
            }

            /* Estilo para items del carrito */
            #cartItems {
                border: 1px solid #dee2e6;
                /* Borde suave */
                border-radius: 5px;
            }

            .cart-item:last-child {
                border-bottom: none !important;
                /* Quitar borde del último item */
            }

            /* Gamer theme adjustments */
            .gamer-card {
                background-color: #343a40;
                /* Dark background */
                color: #f8f9fa;
                /* Light text */
                border: 1px solid #dc3545;
                /* Red border */
            }

            .gamer-card .card-header {
                background-color: #dc3545;
                /* Red header */
                color: #fff;
                border-bottom: 1px solid #bd2130;
                /* Darker red border */
            }

            .gamer-card .card-title {
                color: #fff;
                /* White title text */
            }

            .gamer-input {
                background-color: #495057;
                /* Darker input */
                color: #f8f9fa;
                /* Light text */
                border: 1px solid #6c757d;
                /* Gray border */
            }

            .gamer-input::placeholder {
                color: #adb5bd;
                /* Lighter placeholder */
            }

            .gamer-input:focus {
                background-color: #495057;
                color: #f8f9fa;
                border-color: #dc3545;
                box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
            }

            .gamer-btn {
                background-color: #dc3545;
                border-color: #dc3545;
                color: #fff;
                transition: background-color 0.2s ease, border-color 0.2s ease;
            }

            .gamer-btn:hover {
                background-color: #c82333;
                border-color: #bd2130;
                color: #fff;
            }

            /* Override some bootstrap default styles if needed */
            .table-sm td,
            .table-sm th {
                color: #f8f9fa;
                /* Light text for table cells inside gamer card */
            }

            .custom-control-label {
                color: #f8f9fa;
                /* Light text for radio labels */
            }

            #clienteInfo {
                background-color: #17a2b8;
                /* Info color, adjust if needed */
                border-color: #17a2b8;
            }
        </style>

</body>

</html>