<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/head :: head('Punto de Venta - POS')"></head>

<body class="hold-transition sidebar-mini">
    <div class="wrapper">
        <div th:replace="fragments/header :: header"></div>
        <div th:replace="fragments/sidebar :: sidebar"></div>

        <div class="content-wrapper">
            <div class="content-header">
                <div class="container-fluid">
                    <h1 class="m-0"><i class="fas fa-cash-register"></i> Punto de Venta</h1>
                </div>
            </div>

            <section class="content">
                <div class="container-fluid">

                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-body">
                                    <div class="input-group mb-3">
                                        <input type="text" id="posSearch" class="form-control"
                                            placeholder="Buscar por SKU o nombre">
                                        <div class="input-group-append">
                                            <button class="btn btn-primary" id="posAdd">Agregar</button>
                                        </div>
                                    </div>

                                    <table class="table table-sm" id="posCart">
                                        <thead>
                                            <tr>
                                                <th>SKU</th>
                                                <th>Nombre</th>
                                                <th>Cant.</th>
                                                <th>Precio</th>
                                                <th>Subtotal</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>

                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h4>Total: S/ <span id="posTotal">0.00</span></h4>

                                    <div class="form-group">
                                        <label>Cliente (opcional)</label>
                                        <select class="form-control select2" id="posCliente">
                                            <option value="">Consumidor final</option>
                                            <option th:each="c : ${clientesRecientes}" th:value="${c.id}"
                                                th:text="${c.nombreCompleto}"></option>
                                        </select>
                                    </div>

                                    <div id="posPagos">
                                        <div class="form-group">
                                            <label>Método</label>
                                            <select id="posMetodo" class="form-control">
                                                <option value="EFECTIVO">EFECTIVO</option>
                                                <option value="TARJETA">TARJETA</option>
                                                <option value="YAPE">YAPE</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Monto</label>
                                            <input type="number" id="posMonto" step="0.01" class="form-control">
                                        </div>
                                    </div>

                                    <button id="btnCobrar" class="btn btn-success btn-block">Cobrar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </section>
        </div>

        <div th:replace="fragments/footer :: footer"></div>
    </div>

    <div th:replace="fragments/scripts :: scripts"></div>
    <script>
        $(document).ready(function () {
            function actualizarTotal() {
                let total = 0;
                $('#posCart tbody tr').each(function () {
                    total += parseFloat($(this).find('.subtotal').text()) || 0;
                });
                $('#posTotal').text(total.toFixed(2));
            }

            $('#posAdd').on('click', function () {
                const q = $('#posSearch').val();
                if (!q) { Swal.fire('Atención', 'Ingrese SKU o nombre', 'warning'); return; }
                $.getJSON('/admin/api/productos/buscar', { q: q }, function (resp) {
                    if (resp && resp.length > 0) {
                        const p = resp[0];
                        const row = `<tr data-id="${p.id}">
          <td>${p.codigoSku}</td><td>${p.nombre}</td>
          <td><input type="number" class="form-control cantidad" value="1" min="1" style="width:80px"></td>
          <td>S/ ${parseFloat(p.precioActual).toFixed(2)}</td>
          <td class="subtotal">${parseFloat(p.precioActual).toFixed(2)}</td>
          <td><button class="btn btn-sm btn-danger btn-remove">x</button></td>
        </tr>`;
                        $('#posCart tbody').append(row);
                        actualizarTotal();
                    } else Swal.fire('No encontrado', 'Producto no hallado', 'info');
                });
            });

            $(document).on('input', '.cantidad', function () {
                const tr = $(this).closest('tr');
                const cantidad = parseFloat($(this).val()) || 0;
                const precio = parseFloat(tr.find('td').eq(3).text().replace('S/', '')) || 0;
                tr.find('.subtotal').text((cantidad * precio).toFixed(2));
                actualizarTotal();
            });
            $(document).on('click', '.btn-remove', function () { $(this).closest('tr').remove(); actualizarTotal(); });

            $('#btnCobrar').on('click', function () {
                const total = parseFloat($('#posTotal').text()) || 0;
                if (total <= 0) { Swal.fire('Atención', 'Carrito vacío', 'warning'); return; }
                const metodo = $('#posMetodo').val();
                const monto = parseFloat($('#posMonto').val()) || 0;
                if (monto < total && metodo !== 'EFECTIVO') {
                    // permitimos pagos mixtos en backend; aquí ejemplo simple: exigir al menos el total
                }
                // construir payload
                const detalles = [];
                $('#posCart tbody tr').each(function () {
                    detalles.push({
                        productoId: $(this).data('id'),
                        cantidad: parseFloat($(this).find('.cantidad').val()) || 0
                    });
                });
                const payload = {
                    clienteId: $('#posCliente').val() || null,
                    detalles: detalles,
                    pagos: [{ metodoPago: metodo, monto: monto }]
                };
                // POST a endpoint: POST /admin/ventas/pos (esperado por backend)
                showLoading();
                $.ajax({
                    url: '/admin/ventas/pos',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function (resp) {
                        hideLoading();
                        if (resp.success) {
                            Swal.fire('Éxito', 'Venta registrada', 'success').then(() => { window.location.href = '/admin/ventas/ver/' + resp.id; });
                        } else {
                            Swal.fire('Error', resp.message || 'No se pudo registrar', 'error');
                        }
                    },
                    error: function () { hideLoading(); Swal.fire('Error', 'Fallo en el servidor', 'error'); }
                });
            });
        });
    </script>
</body>

</html>