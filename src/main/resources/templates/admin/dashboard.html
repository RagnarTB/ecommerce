<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{admin/fragments/base}">
<div layout:fragment="content">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Dashboard | E-Commerce</title>

        <!-- Google Font -->
        <link rel="stylesheet"
            href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <!-- AdminLTE -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">

        <style>
            .small-box {
                border-radius: 10px;
                transition: all 0.3s;
            }

            .small-box:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            }

            .card {
                border-radius: 10px;
            }

            .info-box {
                border-radius: 10px;
                transition: all 0.3s;
            }

            .info-box:hover {
                transform: scale(1.02);
            }
        </style>
    </head>

    <body class="hold-transition sidebar-mini layout-fixed">
        <div class="wrapper">

            <!-- Header -->
            <div th:replace="~{admin/fragments/header :: header}"></div>

            <!-- Sidebar -->
            <div th:replace="~{admin/fragments/sidebar :: sidebar}"></div>

            <!-- Content Wrapper -->
            <div class="content-wrapper">
                <!-- Content Header -->
                <div class="content-header">
                    <div class="container-fluid">
                        <div class="row mb-2">
                            <div class="col-sm-6">
                                <h1 class="m-0">
                                    <i class="fas fa-tachometer-alt mr-2"></i>
                                    Dashboard
                                </h1>
                            </div>
                            <div class="col-sm-6">
                                <ol class="breadcrumb float-sm-right">
                                    <li class="breadcrumb-item"><a href="/admin">Inicio</a></li>
                                    <li class="breadcrumb-item active">Dashboard</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main content -->
                <section class="content">
                    <div class="container-fluid">

                        <!-- Mensajes de alerta -->
                        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
                            <button type="button" class="close" data-dismiss="alert">&times;</button>
                            <i class="icon fas fa-ban"></i>
                            <span th:text="${error}"></span>
                        </div>

                        <!-- ========================================
                         ESTADÍSTICAS PRINCIPALES (Small Boxes)
                         ======================================== -->
                        <div class="row">

                            <!-- Ventas del Día -->
                            <div class="col-lg-3 col-6" sec:authorize="hasAuthority('MODULO_VENTAS')">
                                <div class="small-box bg-info">
                                    <div class="inner">
                                        <h3>S/ <span th:text="${#numbers.formatDecimal(ventasDelDia, 1, 2)}">0.00</span>
                                        </h3>
                                        <p>Ventas del Día</p>
                                    </div>
                                    <div class="icon">
                                        <i class="fas fa-cash-register"></i>
                                    </div>
                                    <a th:href="@{/admin/ventas}" class="small-box-footer">
                                        Ver más <i class="fas fa-arrow-circle-right"></i>
                                    </a>
                                </div>
                            </div>

                            <!-- Pedidos Pendientes -->
                            <div class="col-lg-3 col-6" sec:authorize="hasAuthority('MODULO_VENTAS')">
                                <div class="small-box bg-warning">
                                    <div class="inner">
                                        <h3 th:text="${pedidosPendientes}">0</h3>
                                        <p>Pedidos Pendientes</p>
                                    </div>
                                    <div class="icon">
                                        <i class="fas fa-shopping-cart"></i>
                                    </div>
                                    <a th:href="@{/admin/pedidos}" class="small-box-footer">
                                        Ver más <i class="fas fa-arrow-circle-right"></i>
                                    </a>
                                </div>
                            </div>

                            <!-- Total Productos -->
                            <div class="col-lg-3 col-6" sec:authorize="hasAuthority('MODULO_PRODUCTOS')">
                                <div class="small-box bg-success">
                                    <div class="inner">
                                        <h3 th:text="${totalProductos}">0</h3>
                                        <p>Total Productos</p>
                                    </div>
                                    <div class="icon">
                                        <i class="fas fa-box"></i>
                                    </div>
                                    <a th:href="@{/admin/productos}" class="small-box-footer">
                                        Ver más <i class="fas fa-arrow-circle-right"></i>
                                    </a>
                                </div>
                            </div>

                            <!-- Total Clientes -->
                            <div class="col-lg-3 col-6" sec:authorize="hasAuthority('MODULO_CLIENTES')">
                                <div class="small-box bg-danger">
                                    <div class="inner">
                                        <h3 th:text="${totalClientes}">0</h3>
                                        <p>Total Clientes</p>
                                    </div>
                                    <div class="icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <a th:href="@{/admin/clientes}" class="small-box-footer">
                                        Ver más <i class="fas fa-arrow-circle-right"></i>
                                    </a>
                                </div>
                            </div>

                        </div>

                        <!-- ========================================
                         ALERTAS IMPORTANTES (Info Boxes)
                         ======================================== -->
                        <div class="row">

                            <!-- Stock Bajo -->
                            <div class="col-md-3 col-sm-6 col-12" sec:authorize="hasAuthority('MODULO_PRODUCTOS')">
                                <div class="info-box bg-gradient-danger">
                                    <span class="info-box-icon"><i class="fas fa-exclamation-triangle"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Stock Bajo</span>
                                        <span class="info-box-number" th:text="${productosStockBajo}">0</span>
                                        <div class="progress">
                                            <div class="progress-bar" style="width: 70%"></div>
                                        </div>
                                        <span class="progress-description">
                                            <a th:href="@{/admin/inventario/stock-bajo}" class="text-white">
                                                <u>Ver productos</u>
                                            </a>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Créditos Activos -->
                            <div class="col-md-3 col-sm-6 col-12" sec:authorize="hasAuthority('MODULO_VENTAS')">
                                <div class="info-box bg-gradient-info">
                                    <span class="info-box-icon"><i class="fas fa-credit-card"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Créditos Activos</span>
                                        <span class="info-box-number" th:text="${creditosActivos}">0</span>
                                        <div class="progress">
                                            <div class="progress-bar" style="width: 50%"></div>
                                        </div>
                                        <span class="progress-description">
                                            <a th:href="@{/admin/creditos}" class="text-white">
                                                <u>Ver créditos</u>
                                            </a>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Deuda Total -->
                            <div class="col-md-3 col-sm-6 col-12" sec:authorize="hasAuthority('MODULO_VENTAS')">
                                <div class="info-box bg-gradient-warning">
                                    <span class="info-box-icon"><i class="fas fa-money-bill-wave"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Deuda Total</span>
                                        <span class="info-box-number">
                                            S/ <span th:text="${#numbers.formatDecimal(deudaTotal, 1, 2)}">0.00</span>
                                        </span>
                                        <div class="progress">
                                            <div class="progress-bar" style="width: 85%"></div>
                                        </div>
                                        <span class="progress-description">
                                            <a th:href="@{/admin/creditos}" class="text-white">
                                                <u>Gestionar</u>
                                            </a>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Cuotas Vencidas -->
                            <div class="col-md-3 col-sm-6 col-12" sec:authorize="hasAuthority('MODULO_VENTAS')">
                                <div class="info-box bg-gradient-danger">
                                    <span class="info-box-icon"><i class="fas fa-calendar-times"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text">Cuotas Vencidas</span>
                                        <span class="info-box-number" th:text="${cuotasVencidas}">0</span>
                                        <div class="progress">
                                            <div class="progress-bar" style="width: 100%"></div>
                                        </div>
                                        <span class="progress-description">
                                            <a th:href="@{/admin/creditos/cuotas-vencidas}" class="text-white">
                                                <u>Ver cuotas</u>
                                            </a>
                                        </span>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- ========================================
                         CONTENIDO PRINCIPAL
                         ======================================== -->
                        <div class="row">

                            <!-- ========================================
                             ÚLTIMAS VENTAS
                             ======================================== -->
                            <div class="col-md-8" sec:authorize="hasAuthority('MODULO_VENTAS')">
                                <div class="card">
                                    <div class="card-header border-0">
                                        <h3 class="card-title">
                                            <i class="fas fa-cash-register mr-2"></i>
                                            Últimas Ventas del Día
                                        </h3>
                                        <div class="card-tools">
                                            <a th:href="@{/admin/ventas}" class="btn btn-tool btn-sm">
                                                <i class="fas fa-eye"></i> Ver todas
                                            </a>
                                        </div>
                                    </div>
                                    <div class="card-body table-responsive p-0">
                                        <table class="table table-striped table-valign-middle">
                                            <thead>
                                                <tr>
                                                    <th>Nº Venta</th>
                                                    <th>Cliente</th>
                                                    <th>Tipo Pago</th>
                                                    <th>Total</th>
                                                    <th>Hora</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="venta : ${ultimasVentas}">
                                                    <td>
                                                        <small class="badge badge-info"
                                                            th:text="${venta.numeroVenta}">V-001</small>
                                                    </td>
                                                    <td th:text="${venta.cliente.nombreCompleto}">Cliente</td>
                                                    <td>
                                                        <span class="badge"
                                                            th:classappend="${venta.tipoPago.name() == 'CONTADO'} ? 'badge-success' : 'badge-warning'"
                                                            th:text="${venta.tipoPago}">CONTADO</span>
                                                    </td>
                                                    <td>
                                                        <strong>S/ <span
                                                                th:text="${#numbers.formatDecimal(venta.total, 1, 2)}">0.00</span></strong>
                                                    </td>
                                                    <td>
                                                        <small
                                                            th:text="${#temporals.format(venta.fechaVenta, 'HH:mm')}">10:30</small>
                                                    </td>
                                                    <td>
                                                        <a th:href="@{/admin/ventas/ver/{id}(id=${venta.id})}"
                                                            class="btn btn-xs btn-info">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                                <tr th:if="${#lists.isEmpty(ultimasVentas)}">
                                                    <td colspan="6" class="text-center text-muted">
                                                        <i class="fas fa-info-circle mr-2"></i>
                                                        No hay ventas registradas hoy
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- ========================================
                             PRODUCTOS CON STOCK BAJO
                             ======================================== -->
                            <div class="col-md-4" sec:authorize="hasAuthority('MODULO_PRODUCTOS')">
                                <div class="card">
                                    <div class="card-header border-0">
                                        <h3 class="card-title">
                                            <i class="fas fa-exclamation-triangle mr-2"></i>
                                            Stock Bajo
                                        </h3>
                                    </div>
                                    <div class="card-body p-0">
                                        <ul class="products-list product-list-in-card pl-2 pr-2">
                                            <li class="item" th:each="producto : ${productosAlerta}">
                                                <div class="product-img">
                                                    <img th:src="${producto.imagenPrincipal != null ? producto.imagenPrincipal.url : 'https://via.placeholder.com/50'}"
                                                        alt="Producto" class="img-size-50">
                                                </div>
                                                <div class="product-info">
                                                    <a th:href="@{/admin/productos/ver/{id}(id=${producto.id})}"
                                                        class="product-title" th:text="${producto.nombre}">
                                                        Producto
                                                    </a>
                                                    <span class="product-description">
                                                        <span class="badge badge-danger">
                                                            Stock: <span th:text="${producto.stockActual}">0</span>
                                                        </span>
                                                        <span class="badge badge-info">
                                                            Mínimo: <span th:text="${producto.stockMinimo}">0</span>
                                                        </span>
                                                    </span>
                                                </div>
                                            </li>
                                            <li th:if="${#lists.isEmpty(productosAlerta)}"
                                                class="text-center text-muted p-3">
                                                <i class="fas fa-check-circle mr-2"></i>
                                                Todos los productos tienen stock suficiente
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="card-footer text-center" th:if="${!#lists.isEmpty(productosAlerta)}">
                                        <a th:href="@{/admin/inventario/stock-bajo}" class="uppercase">Ver Todos</a>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- ========================================
                         PEDIDOS PENDIENTES
                         ======================================== -->
                        <div class="row" sec:authorize="hasAuthority('MODULO_VENTAS')">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header border-0">
                                        <h3 class="card-title">
                                            <i class="fas fa-shopping-cart mr-2"></i>
                                            Pedidos Pendientes de Confirmación
                                        </h3>
                                        <div class="card-tools">
                                            <span class="badge badge-warning" th:text="${pedidosPendientes}">0</span>
                                        </div>
                                    </div>
                                    <div class="card-body table-responsive p-0">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Nº Pedido</th>
                                                    <th>Cliente</th>
                                                    <th>Productos</th>
                                                    <th>Total</th>
                                                    <th>Entrega</th>
                                                    <th>Fecha</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="pedido : ${ultimosPedidos}">
                                                    <td>
                                                        <small class="badge badge-warning"
                                                            th:text="${pedido.numeroPedido}">P-001</small>
                                                    </td>
                                                    <td th:text="${pedido.cliente.nombreCompleto}">Cliente</td>
                                                    <td>
                                                        <small th:text="${#lists.size(pedido.detalles)} + ' items'">0
                                                            items</small>
                                                    </td>
                                                    <td>
                                                        <strong>S/ <span
                                                                th:text="${#numbers.formatDecimal(pedido.total, 1, 2)}">0.00</span></strong>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-secondary"
                                                            th:text="${pedido.tipoEntrega}">RECOJO</span>
                                                    </td>
                                                    <td>
                                                        <small
                                                            th:text="${#temporals.format(pedido.fechaPedido, 'dd/MM/yyyy HH:mm')}">01/01/2025</small>
                                                    </td>
                                                    <td>
                                                        <a th:href="@{/admin/pedidos/ver/{id}(id=${pedido.id})}"
                                                            class="btn btn-xs btn-info" title="Ver detalle">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        <form
                                                            th:action="@{/admin/pedidos/convertir-venta/{id}(id=${pedido.id})}"
                                                            method="post" style="display: inline;"
                                                            onsubmit="return confirm('¿Confirmar y convertir a venta?')">
                                                            <button type="submit" class="btn btn-xs btn-success"
                                                                title="Convertir a venta">
                                                                <i class="fas fa-check"></i>
                                                            </button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                <tr th:if="${#lists.isEmpty(ultimosPedidos)}">
                                                    <td colspan="7" class="text-center text-muted">
                                                        <i class="fas fa-info-circle mr-2"></i>
                                                        No hay pedidos pendientes
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ========================================
                         ACCESOS RÁPIDOS
                         ======================================== -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">
                                            <i class="fas fa-bolt mr-2"></i>
                                            Accesos Rápidos
                                        </h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-2 col-sm-4 col-6"
                                                sec:authorize="hasAuthority('MODULO_VENTAS')">
                                                <a th:href="@{/admin/ventas/pos}" class="btn btn-app bg-success w-100">
                                                    <i class="fas fa-cash-register"></i> POS
                                                </a>
                                            </div>
                                            <div class="col-md-2 col-sm-4 col-6"
                                                sec:authorize="hasAuthority('MODULO_PRODUCTOS')">
                                                <a th:href="@{/admin/productos/nuevo}"
                                                    class="btn btn-app bg-primary w-100">
                                                    <i class="fas fa-plus"></i> Producto
                                                </a>
                                            </div>
                                            <div class="col-md-2 col-sm-4 col-6"
                                                sec:authorize="hasAuthority('MODULO_CLIENTES')">
                                                <a th:href="@{/admin/clientes}" class="btn btn-app bg-info w-100">
                                                    <i class="fas fa-users"></i> Clientes
                                                </a>
                                            </div>
                                            <div class="col-md-2 col-sm-4 col-6"
                                                sec:authorize="hasAuthority('MODULO_VENTAS')">
                                                <a th:href="@{/admin/creditos}" class="btn btn-app bg-warning w-100">
                                                    <i class="fas fa-credit-card"></i> Créditos
                                                </a>
                                            </div>
                                            <div class="col-md-2 col-sm-4 col-6"
                                                sec:authorize="hasAuthority('MODULO_REPORTES')">
                                                <a th:href="@{/admin/reportes/ventas}"
                                                    class="btn btn-app bg-danger w-100">
                                                    <i class="fas fa-chart-bar"></i> Reportes
                                                </a>
                                            </div>
                                            <div class="col-md-2 col-sm-4 col-6">
                                                <a href="/" target="_blank" class="btn btn-app bg-secondary w-100">
                                                    <i class="fas fa-store"></i> Catálogo
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </section>
            </div>

            <!-- Footer -->
            <footer class="main-footer">
                <strong>Copyright &copy; 2025 <a href="#">E-Commerce System</a>.</strong>
                Todos los derechos reservados.
                <div class="float-right d-none d-sm-inline-block">
                    <b>Version</b> 1.0.0
                </div>
            </footer>

        </div>

        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <!-- Bootstrap 4 -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- AdminLTE App -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>

        <script>
            $(document).ready(function () {
                // Auto-cerrar alertas
                setTimeout(function () {
                    $('.alert').fadeOut('slow');
                }, 5000);

                // Actualizar hora actual
                function actualizarHora() {
                    const now = new Date();
                    const hora = now.toLocaleTimeString('es-PE');
                    $('.hora-actual').text(hora);
                }
                setInterval(actualizarHora, 1000);
            });
        </script>
    </body>
</div>

</html>