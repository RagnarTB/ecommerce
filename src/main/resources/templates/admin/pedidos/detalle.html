<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{admin/fragments/base}">

<head>
    <title th:text="${titulo}">Detalle del Pedido</title>
</head>

<body>
    <div layout:fragment="content">
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1>
                            <i class="fas fa-shopping-bag"></i>
                            Pedido <span th:text="${pedido.numeroPedido}">PED-2025-00001</span>
                        </h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a th:href="@{/admin/pedidos}">Pedidos</a></li>
                            <li class="breadcrumb-item active">Detalle</li>
                        </ol>
                    </div>
                </div>
            </div>
        </section>

        <section class="content">
            <div class="container-fluid">

                <!-- Botones de acción según estado -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="btn-group">
                            <button th:if="${pedido.estado.name() == 'PENDIENTE'}" type="button" class="btn btn-success"
                                onclick="confirmarPedido()">
                                <i class="fas fa-check"></i> Confirmar Pedido
                            </button>

                            <button th:if="${pedido.estado.name() == 'CONFIRMADO'}" type="button"
                                class="btn btn-primary" onclick="convertirAVenta()">
                                <i class="fas fa-cash-register"></i> Convertir a Venta
                            </button>

                            <button th:if="${pedido.estado.name() != 'CANCELADO'}" type="button" class="btn btn-danger"
                                onclick="cancelarPedido()">
                                <i class="fas fa-times"></i> Cancelar Pedido
                            </button>
                        </div>

                        <a th:href="@{/admin/pedidos}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Volver
                        </a>
                    </div>
                </div>

                <div class="row">

                    <!-- Columna Izquierda -->
                    <div class="col-md-8">

                        <!-- Información del Pedido -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Información del Pedido</h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <dl class="row">
                                            <dt class="col-sm-5">Número:</dt>
                                            <dd class="col-sm-7">
                                                <strong th:text="${pedido.numeroPedido}">PED-2025-00001</strong>
                                            </dd>

                                            <dt class="col-sm-5">Fecha:</dt>
                                            <dd class="col-sm-7"
                                                th:text="${#temporals.format(pedido.fechaPedido, 'dd/MM/yyyy HH:mm')}">
                                                01/01/2025 10:30
                                            </dd>

                                            <dt class="col-sm-5">Estado:</dt>
                                            <dd class="col-sm-7">
                                                <span class="badge badge-lg"
                                                    th:classappend="${pedido.estado.classBootstrap}"
                                                    th:text="${pedido.estado.nombre}">
                                                    Pendiente
                                                </span>
                                            </dd>
                                        </dl>
                                    </div>

                                    <div class="col-md-6">
                                        <dl class="row">
                                            <dt class="col-sm-5">Tipo Entrega:</dt>
                                            <dd class="col-sm-7">
                                                <span th:if="${pedido.tipoEntrega != null}" class="badge badge-info"
                                                    th:text="${pedido.tipoEntrega.nombre}">
                                                    Delivery
                                                </span>
                                            </dd>

                                            <dt class="col-sm-5" th:if="${pedido.direccionEntrega != null}">
                                                Dirección:
                                            </dt>
                                            <dd class="col-sm-7" th:if="${pedido.direccionEntrega != null}"
                                                th:text="${pedido.direccionEntrega}">
                                                Av. Principal 123
                                            </dd>

                                            <dt class="col-sm-5" th:if="${pedido.costoEnvio != null}">
                                                Costo Envío:
                                            </dt>
                                            <dd class="col-sm-7" th:if="${pedido.costoEnvio != null}">
                                                S/ <span th:text="${pedido.costoEnvio}">10.00</span>
                                            </dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Productos del Pedido -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Productos del Pedido</h3>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Producto</th>
                                            <th width="80" class="text-center">Cantidad</th>
                                            <th width="120" class="text-right">P. Unitario</th>
                                            <th width="120" class="text-right">Subtotal</th>
                                            <th width="80">Stock</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="detalle : ${pedido.detalles}">
                                            <td>
                                                <strong th:text="${detalle.nombreProducto}">Laptop HP</strong>
                                                <br>
                                                <small class="text-muted">
                                                    SKU: <span th:text="${detalle.producto.codigoSku}">SKU-001</span>
                                                </small>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge badge-primary" th:text="${detalle.cantidad}">2</span>
                                            </td>
                                            <td class="text-right">
                                                S/ <span th:text="${detalle.precioUnitario}">1000.00</span>
                                            </td>
                                            <td class="text-right">
                                                <strong>S/ <span th:text="${detalle.subtotal}">2000.00</span></strong>
                                            </td>
                                            <td>
                                                <span th:if="${detalle.producto.stockActual >= detalle.cantidad}"
                                                    class="badge badge-success">
                                                    <i class="fas fa-check"></i> OK
                                                </span>
                                                <span th:unless="${detalle.producto.stockActual >= detalle.cantidad}"
                                                    class="badge badge-danger">
                                                    <i class="fas fa-exclamation-triangle"></i> Insuficiente
                                                </span>
                                                <br>
                                                <small class="text-muted">
                                                    Disp: <span th:text="${detalle.producto.stockActual}">0</span>
                                                </small>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Observaciones -->
                        <div th:if="${pedido.observaciones != null}" class="card">
                            <div class="card-header">
                                <h3 class="card-title">Observaciones</h3>
                            </div>
                            <div class="card-body">
                                <p th:text="${pedido.observaciones}">Observaciones del pedido...</p>
                            </div>
                        </div>

                    </div>

                    <!-- Columna Derecha -->
                    <div class="col-md-4">

                        <!-- Cliente -->
                        <div class="card card-primary">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-user"></i> Cliente
                                </h3>
                            </div>
                            <div class="card-body">
                                <dl>
                                    <dt>Nombre Completo:</dt>
                                    <dd>
                                        <strong th:text="${pedido.cliente.nombreCompleto}">
                                            Juan Pérez García
                                        </strong>
                                    </dd>

                                    <dt>Documento:</dt>
                                    <dd>
                                        <span class="badge badge-info"
                                            th:text="${pedido.cliente.tipoDocumento}">DNI</span>
                                        <span th:text="${pedido.cliente.numeroDocumento}">12345678</span>
                                    </dd>

                                    <dt th:if="${pedido.cliente.telefono != null}">Teléfono:</dt>
                                    <dd th:if="${pedido.cliente.telefono != null}" th:text="${pedido.cliente.telefono}">
                                        999888777
                                    </dd>

                                    <dt th:if="${pedido.cliente.email != null}">Email:</dt>
                                    <dd th:if="${pedido.cliente.email != null}" th:text="${pedido.cliente.email}">
                                        cliente@email.com
                                    </dd>
                                </dl>

                                <div class="text-center">
                                    <a th:href="@{/admin/clientes/ver/{id}(id=${pedido.cliente.id})}"
                                        class="btn btn-sm btn-primary">
                                        <i class="fas fa-eye"></i> Ver Perfil
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Totales -->
                        <div class="card card-success">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-calculator"></i> Totales
                                </h3>
                            </div>
                            <div class="card-body">
                                <dl class="row mb-0">
                                    <dt class="col-7">Subtotal:</dt>
                                    <dd class="col-5 text-right">
                                        S/ <span th:text="${pedido.subtotal}">100.00</span>
                                    </dd>

                                    <dt class="col-7" th:if="${pedido.costoEnvio != null and pedido.costoEnvio > 0}">
                                        Envío:
                                    </dt>
                                    <dd class="col-5 text-right"
                                        th:if="${pedido.costoEnvio != null and pedido.costoEnvio > 0}">
                                        + S/ <span th:text="${pedido.costoEnvio}">10.00</span>
                                    </dd>

                                    <dt class="col-7">IGV (18%):</dt>
                                    <dd class="col-5 text-right">
                                        S/ <span th:text="${pedido.igv}">18.00</span>
                                    </dd>
                                </dl>

                                <hr class="my-2">

                                <dl class="row mb-0">
                                    <dt class="col-7">
                                        <h4>TOTAL:</h4>
                                    </dt>
                                    <dd class="col-5 text-right">
                                        <h3 class="text-success mb-0">
                                            S/ <span th:text="${pedido.total}">128.00</span>
                                        </h3>
                                    </dd>
                                </dl>
                            </div>
                        </div>

                        <!-- Timeline de Estados -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Historial</h3>
                            </div>
                            <div class="card-body">
                                <div class="timeline timeline-inverse">
                                    <div>
                                        <i class="fas fa-clock bg-gray"></i>
                                        <div class="timeline-item">
                                            <span class="time">
                                                <i class="fas fa-clock"></i>
                                                <span
                                                    th:text="${#temporals.format(pedido.fechaPedido, 'dd/MM/yyyy HH:mm')}">
                                                    01/01/2025 10:30
                                                </span>
                                            </span>
                                            <h3 class="timeline-header">Pedido Creado</h3>
                                        </div>
                                    </div>

                                    <div th:if="${pedido.estado.name() != 'PENDIENTE'}">
                                        <i class="fas fa-check bg-success"></i>
                                        <div class="timeline-item">
                                            <span class="time">
                                                <i class="fas fa-clock"></i>
                                                <span
                                                    th:text="${#temporals.format(pedido.fechaConfirmacion, 'dd/MM/yyyy HH:mm')}">
                                                    01/01/2025 11:00
                                                </span>
                                            </span>
                                            <h3 class="timeline-header">Pedido Confirmado</h3>
                                        </div>
                                    </div>

                                    <div th:if="${pedido.estado.name() == 'CANCELADO'}">
                                        <i class="fas fa-times bg-danger"></i>
                                        <div class="timeline-item">
                                            <span class="time">
                                                <i class="fas fa-clock"></i> Cancelado
                                            </span>
                                            <h3 class="timeline-header">Pedido Cancelado</h3>
                                        </div>
                                    </div>

                                    <div>
                                        <i class="fas fa-clock bg-gray"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </section>
    </div>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            const pedidoId = /*[[${pedido.id}]]*/ 0;
            function confirmarPedido() {
                Swal.fire({
                    title: '¿Confirmar este pedido?',
                    text: "El pedido quedará listo para convertirse en venta",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, confirmar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = /*[[@{/admin/pedidos/confirmar/}]]*/ '' + pedidoId;
                    }
                });
            }

            function convertirAVenta() {
                Swal.fire({
                    title: '¿Convertir a venta?',
                    html: `
                        <p>Esta acción:</p>
                        <ul style="text-align: left;">
                            <li>Creará una venta en el sistema</li>
                            <li>Descontará el stock de los productos</li>
                            <li>Generará el comprobante</li>
                        </ul>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#007bff',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, convertir',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = /*[[@{/admin/pedidos/convertir-venta/}]]*/ '' + pedidoId;
                    }
                });
            }

            function cancelarPedido() {
                Swal.fire({
                    title: '¿Cancelar este pedido?',
                    text: "Esta acción no se puede deshacer",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, cancelar',
                    cancelButtonText: 'No'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = /*[[@{/admin/pedidos/cancelar/}]]*/ '' + pedidoId;
                    }
                });
            }
        </script>
    </th:block>
</body>

</html>