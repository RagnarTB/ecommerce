<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{admin/fragments/base}">

<head>
    <title th:text="${titulo}">Lista de Clientes</title>
</head>

<body>
    <div layout:fragment="content">
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1><i class="fas fa-users"></i> Gestión de Clientes</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">Dashboard</a></li>
                            <li class="breadcrumb-item active">Clientes</li>
                        </ol>
                    </div>
                </div>
            </div>
        </section>

        <section class="content">
            <div class="container-fluid">

                <!-- Mensajes -->
                <div th:if="${success}" class="alert alert-success alert-dismissible">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <i class="icon fas fa-check"></i> <span th:text="${success}"></span>
                </div>

                <div th:if="${error}" class="alert alert-danger alert-dismissible">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <i class="icon fas fa-ban"></i> <span th:text="${error}"></span>
                </div>

                <!-- Búsqueda Rápida -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" id="buscarCliente" class="form-control"
                                placeholder="Buscar por nombre o documento...">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 text-right">
                        <button type="button" class="btn btn-info" onclick="exportarExcel()">
                            <i class="fas fa-file-excel"></i> Exportar Excel
                        </button>
                    </div>
                </div>

                <!-- Tarjetas de Resumen -->
                <div class="row mb-3">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-info">
                            <div class="inner">
                                <h3 th:text="${totalClientes ?: 0}">0</h3>
                                <p>Total Clientes</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-success">
                            <div class="inner">
                                <h3 th:text="${clientesActivos ?: 0}">0</h3>
                                <p>Clientes Activos</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-warning">
                            <div class="inner">
                                <h3 th:text="${clientesConCredito ?: 0}">0</h3>
                                <p>Con Crédito Activo</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-danger">
                            <div class="inner">
                                <h3>S/ <span th:text="${deudaTotal ?: 0}">0.00</span></h3>
                                <p>Deuda Total</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Clientes -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Clientes</h3>
                    </div>
                    <div class="card-body">
                        <table id="tablaClientes" class="table table-bordered table-striped table-hover">
                            <thead>
                                <tr>
                                    <th width="80">Tipo</th>
                                    <th width="120">Documento</th>
                                    <th>Nombre / Razón Social</th>
                                    <th width="130">Teléfono</th>
                                    <th width="100">Compras</th>
                                    <th width="100">Deuda</th>
                                    <th width="100">Estado</th>
                                    <th width="130">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="cliente : ${clientes}">
                                    <td>
                                        <span class="badge"
                                            th:classappend="${cliente.tipoDocumento.name() == 'DNI'} ? 'badge-primary' : 'badge-info'"
                                            th:text="${cliente.tipoDocumento}">
                                            DNI
                                        </span>
                                    </td>
                                    <td>
                                        <strong th:text="${cliente.numeroDocumento}">12345678</strong>
                                    </td>
                                    <td>
                                        <strong th:text="${cliente.nombreCompleto}">Juan Pérez García</strong>
                                        <br>
                                        <small class="text-muted" th:if="${cliente.email != null}">
                                            <i class="fas fa-envelope"></i>
                                            <span th:text="${cliente.email}">email@example.com</span>
                                        </small>
                                    </td>
                                    <td>
                                        <span th:if="${cliente.telefono != null}" th:text="${cliente.telefono}">
                                            999888777
                                        </span>
                                        <span th:unless="${cliente.telefono != null}" class="text-muted">-</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-success">
                                            <span th:text="${cliente.totalCompras ?: 0}">0</span>
                                        </span>
                                    </td>
                                    <td class="text-right">
                                        <span th:if="${cliente.deudaActual != null and cliente.deudaActual > 0}"
                                            class="text-danger">
                                            <strong>S/ <span th:text="${cliente.deudaActual}">0.00</span></strong>
                                        </span>
                                        <span th:unless="${cliente.deudaActual != null and cliente.deudaActual > 0}"
                                            class="text-muted">
                                            S/ 0.00
                                        </span>
                                    </td>
                                    <td>
                                        <span th:if="${cliente.activo}" class="badge badge-success">Activo</span>
                                        <span th:unless="${cliente.activo}" class="badge badge-danger">Inactivo</span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a th:href="@{/admin/clientes/ver/{id}(id=${cliente.id})}"
                                                class="btn btn-info" title="Ver Detalle">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a th:href="@{/admin/ventas?clienteId={id}(id=${cliente.id})}"
                                                class="btn btn-success" title="Ver Compras">
                                                <i class="fas fa-shopping-cart"></i>
                                            </a>
                                            <a th:if="${cliente.deudaActual != null and cliente.deudaActual > 0}"
                                                th:href="@{/admin/creditos?clienteId={id}(id=${cliente.id})}"
                                                class="btn btn-warning" title="Ver Créditos">
                                                <i class="fas fa-credit-card"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Documento</th>
                                    <th>Nombre / Razón Social</th>
                                    <th>Teléfono</th>
                                    <th>Compras</th>
                                    <th>Deuda</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

            </div>
        </section>
    </div>

    <th:block layout:fragment="scripts">
        <script>
            $(document).ready(function () {
                var tabla = $('#tablaClientes').DataTable({
                    "responsive": true,
                    "lengthChange": true,
                    "autoWidth": false,
                    "order": [[2, "asc"]], // Ordenar por nombre
                    "pageLength": 25,
                    "language": {
                        "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json"
                    },
                    "buttons": [
                        {
                            extend: 'excelHtml5',
                            text: '<i class="fas fa-file-excel"></i> Excel',
                            className: 'btn btn-success btn-sm',
                            title: 'Listado de Clientes',
                            exportOptions: {
                                columns: [0, 1, 2, 3, 4, 5, 6]
                            }
                        },
                        {
                            extend: 'pdfHtml5',
                            text: '<i class="fas fa-file-pdf"></i> PDF',
                            className: 'btn btn-danger btn-sm',
                            title: 'Listado de Clientes',
                            orientation: 'landscape',
                            exportOptions: {
                                columns: [0, 1, 2, 3, 4, 5, 6]
                            }
                        }
                    ]
                }).buttons().container().appendTo('#tablaClientes_wrapper .col-md-6:eq(0)');

                // Búsqueda personalizada
                $('#buscarCliente').on('keyup', function () {
                    tabla.search(this.value).draw();
                });
            });

            function exportarExcel() {
                $('#tablaClientes').DataTable().button('.buttons-excel').trigger();
            }
        </script>
    </th:block>
</body>

</html>